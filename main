#!/bin/bash
#PBS -l nodes=1:ppn=1,walltime=0:15:00
#PBS -N FSLBET
#PBS -V

if [ $ENV == "IUHPC" ]; then
    module load fsl
fi

mkdir mask
mkdir dwi

export dwi=$(jq -r .dwi config.json)
export bvals=$(jq -r .bvals config.json)
export bvecs=$(jq -r .bvecs config.json)
export fthresh=$(jq -r .fthreshold config.json)
export gthresh=$(jq -r .gthreshold config.json)

cp ${dwi} dwi_original.nii.gz;
cp ${bvals} ./dwi/dwi.bvals;
cp ${bvecs} ./dwidwi.bvecs;

select_dwi_vols \
    dwi_original.nii.gz \
    ${bvals} \
    nodif.nii.gz \
    0;
    
fslmaths nodif \
    -Tmean \
    nodif_mean;

# Brain extraction before alignment
bet nodif_mean.nii.gz \
    dwi \
    -f $fthresh \
    -g $gthresh \
    -m;

mv dwi_mask.nii.gz ./mask/mask.nii.gz;
rm -rf nodif.nii.gz nodif_mean.nii.gz dwi_original.nii.gz

